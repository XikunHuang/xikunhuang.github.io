---
title: 个人主页搭建记录之GitHub Pages/Actions + Jekyll + Minimal Mistakes + Pandoc
date: 2020-07-31
tags:
    - jekyll
    - github_pages
---

## 为什么要搭建个人主页

想了一下主要有以下几个原因:

- 提醒自己及时**记录**所看所思所想.

- **练习**写作能力.

- **分享**自己学习到的知识.

最近越发觉得及时记录自己学到的知识是很重要的一件事, 一方面是好记性不如烂笔头(况且记性还越来越差-.-), 及时记录下来之后方便以后查阅, 因为有些问题过段时间后可能会再次遇到, 查阅之前的记录会大大缩短解决问题需要的时间. 另一方面是在记录的过程中可以训练自己写作的能力, 比如用清晰简洁的语言描述遇到的问题和相应的解决方案. 在写作的过程中可能还会加深对相关知识的理解, 因为写作的过程会不断的思考. 而且我认为写作是需要不断练习才能驾轻就熟的. 此外, 分享也是我创建个人主页的原因. 我在网上寻找相关知识或一些问题的解决方案时发现了很多优质的博客, 他们把自己的知识无偿的分享出来, 从中我学到了很多, 我非常认同这种分享精神, 所以我也想把自己的一些经验分享出来, 如果能帮到别人, 那将是令我非常开心的一件事.

## 希望有一个什么样的个人主页

我对自己的主页有以下几个期待:

- 专注于内容

- 方便维护

- 页面简洁

- 有一些方便的功能如文章标签, 搜索, 评论等

- 可以被搜索引擎检索到

我希望自己的主页专注于内容, 一方面是在主页里以博客为主, 另一方面是希望可以很简单的将博客发布到个人网页, 这里的简单是指不必改变自己现在的写作环境(Markdown+Pandoc)以及写完后不需要做什么额外的操作, 维护个人主页不需要花费很多的精力. 相比于外表非常酷炫的网页, 我更喜欢简洁的风格. 此外, 为了更好地使用个人主页, 我认为文章标签, 搜索, 评论等功能还是有必要的. 当然, 如果搜索引擎检索不到自己的网页, 那么分享的功能会大打折扣.

## 搭建过程

### 工具的选择

我的电脑系统是Ubuntu18.04, 我最终采用的方案是: **GitHub Pages/Actions + Jekyll + Minimal Mistakes + Pandoc**, 原因如下:

- GitHub Pages

    我暂时不想自己购买云服务器, 所以GitHub Pages自然成了一个很好的选择.

- Hexo or Jekyll

    之前用Hexo搭建过, 后来没有坚持更新(第一次搭建都会遇到的问题?哈哈), 还有一个重要的原因是我觉得发布博客有点费事. 所以这次我就试了试Jekyll, 它专注于内容的特性吸引了我.

- 为什么不用Gem包github-pages

    github-pages限制较多, 只能使用部分插件和版本, 主题使用也受限, 虽然可以通过remote theme解决部分主题的问题, 但是本地测试还是麻烦.

- Minimal Mistakes

    页面简洁, 功能丰富, 文档清晰, 用户众多, 并且一直被主题作者很好地维护着.

- GitHub Actions

    我的理解是免费给用户配了一台远程服务器. 解决了上述gh-pages的限制, 逻辑上就是将源文件放在gh-pages分支中, 本地修改推送到gh-pages分支, 然后gh-pages分支的更新会触发GitHub Actions工作流配置的一些操作, 这里是在远程服务器上下载Pandoc, Ruby, Jekyll. 将gh-pages分支中的源文件处理成静态网站文件推送到master分支.

    题外话, 如果是为非username.github.io的仓库创建网页(比如为某个仓库myproject创建文档), 那么可以将源文件放在gh-pages分支中, 然后将生成后的静态网页文件部署在master分支中的docs文件夹内. 在myproject仓库设置中设置github pages网址为https://username.github.io/docs. 也可以直接将网站部署在gh-pages分支上, 这样需要在myproject仓库设置中设置github pages网址为gh-pages分支.

- Pandoc

    文件转换的瑞士军刀, 非常强大的软件. 我选择它的主要原因是在处理Markdown文件时对$\LaTeX$数学公式支持的很好, 可以使用和$\LaTeX$一样的数学环境语法处理行内公式和数学环境(单美元符号和双美元符号).

### 具体搭建过程

搜索关键词GitHub Pages + Jekyll, 可以找到很多搭建教程, 比如这几个. 我的搭建过程和这些教程里介绍的差不多, 所以这里我就不写的那么详细了, 我主要是记录一下我做的一些更改, 包括使用Pandoc作为markdown解释器和使用GitHub Actions进行网站的自动部署.

1. **创建GitHub仓库**

    在GitHub上新建一个名为 username.github.io 的空的仓库, 这里username替换为自己的github名称. 然后在该仓库中创建一个名为gh-pages的分支. 将gh-pages分支clone到本地, 以后的操作全部在gh-pages分支中. master分支只是用来发布最后生成的静态网站(由GithHub Actions工作流自动完成).

1. **安装本地测试环境**

    本地安装[Ruby][Ruby], [Jekyll][Jekyll], [Pandoc][Pandoc]用于测试, 具体安装方法可以参考对应的官方网站安装指南.

1. **Jekyll主题 Minimal Mistakes**

    GitHub下载[Minimal Mistakes][mminstakes]的仓库, 将[docs文件夹][mmistakes-docs]内的内容全部放到之前clone下来的username.github.io文件夹内.

1. **配置Minimal Mistakes主题**

    - 添加[jekyll-pandoc][jekyll-pandoc]插件, Gemfile和_config.yml文件中都要添加. 然后在_config.yml中修改markdown引擎为Pandoc, 并进行Pandoc命令的配置. 具体配置见后文.

    - _config.yml中主题选择使用theme而不是remote theme.

    - Gemfile中注释掉 gem "github-pages", group: :jekyll_plugins, 替换为 gem "jekyll".

1. **本地测试**

    在username.github.io文件夹根目录下终端执行以下命令:

    ```bash
    # 安装gem包
    bundle
    # 运行服务
    bundle exec jekyll serve
    ```

    成功的话会生成_sites文件夹, 浏览器访问 https://localhost:4000 即可查看网页.

1. **创建GitHub Actions自动部署流程**

    在username.github.io文件夹下创建 ./github/workflows/gh-pages.yml 文件, 我使用的配置为:

    ```yaml
    name: Build and deploy jekyll site

    on:
        push:
            branches:
                - gh-pages

    jobs:
        jekyll:
            runs-on: ubuntu-18.04
            steps:
                - name: 📂 setup
                    uses: actions/checkout@v2

                - name: setup pandoc
                    uses: r-lib/actions/setup-pandoc@v1
                    with:
                    pandoc-version: '2.7.3'

                - name: 💎 setup ruby
                    uses: ruby/setup-ruby@v1
                    with:
                    ruby-version: 2.6

                - name: 🔨 install dependencies & build site
                    uses: limjh16/jekyll-action-ts@v2
                    with:
                    enable_cache: true

                - name: 🚀 deploy
                    uses: peaceiris/actions-gh-pages@v3
                    with:
                    github_token: ${{ secrets.GITHUB_TOKEN }}
                    publish_dir: ./_site
                    publish_branch: master
    ```

    上述配置文件参考自 [limjh16/jekyll-action-ts][jekyll-action-ts],  [peaceiris/actions-gh-pages][actions-gh-pages] 和 [r-lib/actions][r-lib].

1. **推送到GitHub**

    在username.github.io文件夹下终端运行git推送到远程gh-pages分支, 然后就可以去GitHub网站上的username.github.io仓库中的Actions页面查看进度, 成功完成之后就可以 https://username.github.io 访问主页了.

    ```bash
    # 确保是在gh-pages分支
    git checkout gh-pages
    # 添加
    git add .
    # 提交
    git commit -m "initial commit"
    # 推送
    git push origin gh-pages
    ```

## 发布博客的流程

1. 使用VSCode写markdown文件, 搭配Pandoc预览.

2. 将写好的balbla.md文件重命名为Year-Month-Day-blabla.md的形式, 放到主页存放博客的文件夹内(_posts)

3. 这一步可选. 发布到GitHub Pages之前在本地预览效果, 在主页源文件根目录终端运行:

    ```bash
    bundle exec jekyll serve
    ```

4. 使用git将博客发布到GitHub Pages. 在主页源文件根目录执行git add, commit, push origin gh-pages操作.

## 遇到的问题及解决方案

1. Markdown文件中使用$\LaTeX$ 数学公式的语法以及后续的渲染.

    - 使用 jekyll-pandoc解决, Gemfile和_config.yml中添加上该插件. 并且在_config.yml中配置Pandoc

        ```yaml
        # Conversion
        markdown: Pandoc
        highlighter: rouge
        lsi: false
        excerpt_separator: "<!--more-->" # excerpt "\n\n", set in archive-single.html
        incremental: false

        # Markdown Processing
        pandoc:
            extensions:
                - mathjax
                - from=markdown
                - to=html
                - number-sections
                - shift-heading-level-by=-1
        ```

    - \_includes/scripts.html 添加mathjax的链接. 关于mathjax的设置可以参考 [mathjax官方文档][mathjax-doc], mathjax对$\LaTeX$的支持可以参考 [Supported TeX/LaTeX commands][mathjax-latex].

        ```html
        {% raw %}
        {% if page.mathjax %}
        <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            chtml: {
                scale: 0.8,  // global scaling factor for all expressions
            }
        };
        </script>

        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js">
        </script>
        {% endif %}
        {% endraw %}
        ```

    - GitHub Actions 工作流中添加安装Pandoc这一步.

1. Markdown切换为Pandoc时文章目录生成错误.

    原因是Pandoc和Kramdown在Markdown文件中添加Html标签的语法不同, Minimal Mistakes支持Kramdown的语法. 我的解决方法是手动修改include/toc.html文件使得处理后的结果与Kramdown处理后的结果相同. 关键词: {{markdownify}}, liquid过滤器, filter replace.

    ```html
    {% raw %}
    {% comment %}
        ## delete toc__menu, add it later using liquid command.
	    {% if include.class and include.class != blank %}
		    {% capture my_toc %}{:.{{ include.class }}}
	        {{ my_toc | lstrip }}{% endcapture %}
	    {% endif %}
    {% endcomment %}

    {% capture mytoc_html %}
    {{ my_toc | markdownify | strip }}
    {% endcapture %}
    {{ mytoc_html | replace_first: 'ul', 'ul class="toc__menu"' }}
    {% endraw %}
    ```

1. 我对Minimal Mistakes主题作的其他修改

    - 修改about文件

        在_pages/about.md中修改.

    - 添加图标

        使用的是[Font Awesome][FontAwesome]图标.

    - 个人头像

        使用[draw.io][draw-io]画的.

    - 页脚添加Sitemap

        在 _includes/footer.html文件中修改.

    - SEO, [google webmaster tool][google-webmaster-tool], [bing webmaster tool][bing-webmaster-tool].

    - 评论系统, [Disqus][Disqus].

    - 中文定制

        修改 \_data/ui-text.yml, \_data/navigation.yml文件

    - 文章摘录

        excerpt 设置, excerpt_separator. 在_includes/archive-single.html中修改.

    - Pandoc syntax highlight style and css

        我用了个非常简单粗暴的解决方法, 先随便创建一个包含代码块的md文件test.md, 然后运行

        ```bash
         pandoc test.md -s --highlight-style=zenburn -o test.html
        ```

        将test.html里的样式代码复制出来保存成pandoc-zenburn-syntax-highlight.css文件放在assets/css/文件夹内. 在_includes/head/custom.html中添加刚刚创建的css文件链接.

[Ruby]: https://www.ruby-lang.org/en/
[Jekyll]: https://jekyllrb.com/
[Pandoc]: https://pandoc.org/
[mminstakes]: https://github.com/mmistakes/minimal-mistakes
[mmistakes-docs]: https://github.com/mmistakes/minimal-mistakes/tree/master/docs
[jekyll-pandoc]: https://jekyllrb.com/docs/
[jekyll-action-ts]: https://github.com/limjh16/jekyll-action-ts
[actions-gh-pages]: https://github.com/peaceiris/actions-gh-pages
[r-lib]: https://github.com/r-lib/actions
[FontAwesome]: https://fontawesome.com/
[mathjax-doc]: http://docs.mathjax.org/en/latest/web/components/combined.html#tex-chtml-full
[mathjax-latex]: http://docs.mathjax.org/en/latest/input/tex/macros/index.html
[google-webmaster-tool]: https://www.google.com/webmasters/#?modal_active=none
[bing-webmaster-tool]: https://www.bing.com/webmasters
[Disqus]: https://disqus.com/
[draw-io]: https://app.diagrams.net/